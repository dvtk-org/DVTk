name: DVTk Build (VS2022)

on:
  push:
    branches:
      - '*'
  pull_request:
    branches:
      - '*'

env:
  SOLUTION: 'Dicom.sln'
  BUILD_PLATFORM: 'x86'
  BUILD_CONFIGURATION: 'Release'

jobs:
  build:
    runs-on: windows-2022

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v3.0.0
      with:
        versionSpec: '5.x'
        preferLatestVersion: true

    - name: Determine version number using GitVersion
      id: gitversion
      uses: gittools/actions/gitversion/execute@v3.0.0
      with:
        useConfigFile: true
        configFilePath: 'GitVersion.yml'
        updateAssemblyInfo: true

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
      with:
        nuget-config-file: 'NuGet.config'

    - name: Restore Nuget packages
      run: nuget restore ${{ env.SOLUTION }} -Verbosity Detailed

    - name: Update Version in project files
      shell: pwsh
      run: |
        ./DVT/updateVersion.ps1 -gitversion "${{ env.GITVERSION_FULLSEMVER }}"

    - name: Update Copyright year in AssemblyInfo files
      shell: pwsh
      run: |
        ./DVT/updateCopyright.ps1

    - name: Install MFC (Modify existing VS installation)
      shell: cmd
      run: |
        "C:\Program Files (x86)\Microsoft Visual Studio\Installer\setup.exe" modify ^
        --installPath "C:\Program Files\Microsoft Visual Studio\2022\Enterprise" ^
        --add Microsoft.VisualStudio.Component.VC.MFC ^
        --quiet --norestart

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      with:
        vs-version: '[17.0,18.0)'

    - name: Verify MFC Installation
      shell: pwsh
      run: |
        # Gebruik -requires om direct te filteren op de component, dit is betrouwbaarder dan handmatig de lijst doorzoeken
        $mfcCheck = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -requires Microsoft.VisualStudio.Component.VC.MFC -property installationPath
        
        if ($mfcCheck) {
            Write-Host "✅ MFC Component is succesvol gedetecteerd in: $mfcCheck"
        } else {
            Write-Host "⚠️ Waarschuwing: vswhere herkent de component nog niet. We checken nu het bestandssysteem..."
            
            # Fallback: Controleer of de MFC mappen daadwerkelijk bestaan op schijf
            $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath
            $mfcHeader = Get-ChildItem -Path "$vsPath\VC\Tools\MSVC" -Recurse -Filter "afxwin.h" -ErrorAction SilentlyContinue
            
            if ($mfcHeader) {
                Write-Host "✅ MFC bestanden gevonden op schijf: $($mfcHeader.FullName)"
            } else {
                Write-Error "❌ MFC Component NIET gevonden (niet via vswhere en niet op het bestandssysteem)."
                exit 1
            }
        }

    - name: Locate Devenv and Manual Registry Fix
      shell: pwsh
      run: |
        # Search VS2022 via vswhere
        $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -version "[17.0,18.0)" -property installationPath
        $instanceId = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -version "[17.0,18.0)" -property instanceId
        
        if (-not $vsPath) { throw "Visual Studio 2022 not found!" }
        
        # Execute Registry Fix for HRESULT 8000000A 
        $registryPath = "HKCU:\SOFTWARE\Microsoft\VisualStudio\16.0_$($instanceId)_Config\MSBuild"
        if (!(Test-Path $registryPath)) {
            New-Item -Path $registryPath -Force | Out-Null
        }
        Set-ItemProperty -Path $registryPath -Name "EnableOutOfProcBuild" -Value 0 -Type DWord
        Write-Host "Registry fix applied to $registryPath"

        $devenv = Join-Path $vsPath "Common7\IDE\devenv.com"
        Add-Content -Path $env:GITHUB_ENV -Value "DEV_CMD=$devenv"

    - name: Setup Visual Studio Installer Projects
      uses: seanmiddleditch/gha-setup-vsdevenv@v5

    - name: Build managed/native projects (msbuild)
      id: msbuild
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path ./staging
        & msbuild Dicom.sln /t:Rebuild '/p:Configuration=Release;Platform=x86' /m /fl /flp:LogFile=./staging/build-msbuild.log

    - name: Build setup projects (devenv)
      id: vdproj
      continue-on-error: true
      shell: pwsh
      run: |
        $projects = @(
            "DVT Setup",
            "DICOM Editor Setup",
            "DICOM Compare Setup",
            "DICOM Network Analyzer Setup",
            "Query Retrieve SCP Emulator Setup",
            "Query Retrieve SCU Emulator Setup",
            "RIS Emulator Setup",
            "Storage SCP Emulator Setup",
            "Storage SCU Emulator Setup"
        )
        
        if (-not (Test-Path "$env:DEV_CMD")) { throw "Error: DEV_CMD (devenv.com) not found on the system." }
        
        $logPath = "./staging/build-devenv.log"
        if (Test-Path $logPath) { Remove-Item $logPath -Force }
        
        $anyFailure = $false
        
        foreach ($p in $projects) {
            Write-Host "--- Building: $p ---"
            
            $tempLog = "temp_$($p.Replace(' ', '_')).log"
            
            $process = Start-Process -FilePath "$env:DEV_CMD" `
                -ArgumentList "`"$env:SOLUTION`"", "/Build", "`"$env:BUILD_CONFIGURATION|$env:BUILD_PLATFORM`"", "/Project", "`"$p`"", "/Out", "$tempLog" `
                -Wait -PassThru
                
            if (Test-Path $tempLog) {
                $content = Get-Content $tempLog
                $content | Out-File -FilePath $logPath -Append -Encoding UTF8
                $content | Write-Host  # Toon de output ook in de GitHub console
                Remove-Item $tempLog
            }
            
            if ($process.ExitCode -ne 0) {
                Write-Error "Error during build of $p (Exit code: $($process.ExitCode))"
                $anyFailure = $true
            }
        }
        
        if ($anyFailure) { exit 1 }

    - name: Run Tests
      continue-on-error: true
      shell: cmd
      run: |
        vstest.console.exe ".\bin\Release\*Tests.dll" --logger:trx;LogFileName=../staging/test-results.trx

    - name: Upload Test Results Artifact
      uses: actions/upload-artifact@v4
      with:
        name: test-results-trx
        path: staging/*.trx

    - name: Rename MSI files with version number
      shell: pwsh
      run: |
        $searchPath = "bin\Setups\Release"
        $version = "${{ env.GITVERSION_FULLSEMVER }}"
        
        Write-Host "Search all MSI files in: $searchPath"
        $msiFiles = Get-ChildItem -Path $searchPath -Filter "*-a.b.c.msi" -Recurse
        
        if ($msiFiles.Count -eq 0) {
            Write-Warning "No MSI files found with placeholder '-a.b.c.msi'."
        }
        
        foreach ($file in $msiFiles) {
            $newName = $file.Name.Replace("-a.b.c", "-$version")
            $destination = Join-Path "./staging" $newName
            
            Write-Host "Rename: $($file.Name) -> $newName"
            
            # Controleer of het doelbestand al bestaat om fouten te voorkomen
            if (Test-Path $destination) {
                Write-Host "Bestand $newName bestaat al, verwijderen van oud bestand..."
                Remove-Item $destination -Force
            }
            
            Move-Item -Path $file.FullName -Destination $destination -Force
        }
        Get-ChildItem -Path "./staging" -Filter "*.msi" -Recurse | Select-Object FullName

    - name: Publish build artifacts
      if: ${{ always() }}
      uses: actions/upload-artifact@v4
      with:
        name: "${{ github.event.repository.name }}-Package-${{ env.GITVERSION_FULLSEMVER }}"
        path: ./staging

  publish-test-results:
    runs-on: ubuntu-latest
    needs: build
    if: always()
    permissions:
      checks: write
      pull-requests: write
      contents: read
    steps:
      - name: Download Test Results
        uses: actions/download-artifact@v4
        with:
          name: test-results-trx
          path: test-results

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: "test-results/**/*.trx"