name: .NET Desktop Build (VS2019)

on:
  push:
    branches:
      - '*'
  pull_request:
    branches:
      - '*'

env:
  SOLUTION: 'Dicom.sln'
  BUILD_PLATFORM: 'x86'
  BUILD_CONFIGURATION: 'Release'

jobs:
  build:
    runs-on: windows-2019

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v3.0.0
      with:
        versionSpec: '5.x'
        preferLatestVersion: true

    - name: Determine version number using GitVersion
      id: gitversion
      uses: gittools/actions/gitversion/execute@v3.0.0
      with:
        useConfigFile: true
        configFilePath: 'GitVersion.yml'
        updateAssemblyInfo: true

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
      with:
        nuget-config-file: 'NuGet.config'

    - name: Restore Nuget packages
      run: nuget restore ${{ env.SOLUTION }} -Verbosity Detailed

    - name: Update Version in project files
      shell: pwsh
      run: |
        ./DVT/updateVersion.ps1 -gitversion "${{ env.GITVERSION_FULLSEMVER }}"

    - name: Update Copyright year in AssemblyInfo files
      shell: pwsh
      run: |
        ./DVT/updateCopyright.ps1

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Locate Devenv and Manual Registry Fix
      shell: pwsh
      run: |
        # Zoek VS2019 gegevens via vswhere
        $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -version "[16.0,17.0)" -property installationPath
        $instanceId = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -version "[16.0,17.0)" -property instanceId
        
        if (-not $vsPath) { throw "Visual Studio 2019 niet gevonden!" }
        
        # Voer Registry Fix uit voor HRESULT 8000000A 
        $registryPath = "HKCU:\SOFTWARE\Microsoft\VisualStudio\16.0_$($instanceId)_Config\MSBuild"
        if (!(Test-Path $registryPath)) {
            New-Item -Path $registryPath -Force | Out-Null
        }
        Set-ItemProperty -Path $registryPath -Name "EnableOutOfProcBuild" -Value 0 -Type DWord
        Write-Host "Registry fix toegepast op $registryPath"

        # Sla pad op voor volgende stappen
        $devenv = Join-Path $vsPath "Common7\IDE\devenv.com"
        Add-Content -Path $env:GITHUB_ENV -Value "DEV_CMD=$devenv"

    - name: Setup Visual Studio Installer Projects
      uses: seanmiddleditch/gha-setup-vsdevenv@v5

    - name: Build managed/native projects (msbuild)
      id: msbuild
      shell: cmd
      run: |
        msbuild Dicom.sln /t:Rebuild /p:Configuration=Release;Platform=x86 /m > build-msbuild.log 2>&1

    - name: Upload msbuild log
      if: ${{ always() }}
      uses: actions/upload-artifact@v4
      with:
        name: build-msbuild-log-${{ github.run_id }}
        path: build-msbuild.log

    - name: Build setup projects (devenv)
      id: vdproj
      continue-on-error: true
      shell: pwsh
      run: |
        $projects = @( "DVT Setup", "DICOM Editor Setup", "DICOM Compare Setup", "DICOM Network Analyzer Setup", "Query Retrieve SCP Emulator Setup", "Query Retrieve SCU Emulator Setup", "RIS Emulator Setup", "Storage SCP Emulator Setup", "Storage SCU Emulator Setup" )
        if (-not (Test-Path "$env:DEV_CMD")) { throw "DEV_CMD niet gevonden" }
        if (Test-Path build-devenv.log) { Remove-Item build-devenv.log -Force }

        $anyFailure = $false
        foreach ($p in $projects) {
            Write-Host "=== Building setup project: $p ==="
            $buildParams = @( "$env:SOLUTION", '/Build', "$($env:BUILD_CONFIGURATION)|$($env:BUILD_PLATFORM)", '/Project', $p )
            
            # Gebruik UTF8 om leesbare logs te krijgen 
            Add-Content -Path build-devenv.log -Value ("`n=== CMD for project: $p ===") -Encoding UTF8
            
            # Voer build uit, toon live output en sla op in logbestand 
            & "$env:DEV_CMD" @buildParams | ForEach-Object {
                Write-Host $_ 
                $_ | Out-File -FilePath build-devenv.log -Append -Encoding UTF8
            }

            $exit = $LASTEXITCODE
            Write-Host "devenv exitcode for '$p': $exit"
            if ($exit -ne 0) {
              Write-Host "WARNING: build failed for project '$p' (exit $exit)."
              $anyFailure = $true
            }
        }
        Copy-Item build-devenv.log -Destination staging
        if ($anyFailure) { exit 1 }

    - name: Show last lines of build log (only if build failed)
      if: ${{ steps.vdproj.outcome == 'failure' }}
      shell: pwsh
      run: |
        if (Test-Path build-devenv.log) {
          Write-Host "=== Last 200 lines of build-devenv.log ==="
          Get-Content build-devenv.log -Tail 200
        }

    - name: Run Tests
      if: ${{ always() }}
      shell: cmd
      run: |
        vstest.console.exe ".\bin\Release\*Tests.dll"

    - name: Rename MSI files with version number
      if: ${{ always() }}
      shell: pwsh
      run: |
        $searchPath = "bin\Setups\Release"
        $version = "${{ env.GITVERSION_FULLSEMVER }}"
        
        Write-Host "Zoeken naar MSI bestanden in: $searchPath"
        
        # Zoek alle MSI bestanden die de placeholder '-a.b.c' bevatten
        $msiFiles = Get-ChildItem -Path $searchPath -Filter "*-a.b.c.msi" -Recurse
        
        if ($msiFiles.Count -eq 0) {
            Write-Warning "Geen MSI bestanden gevonden met de placeholder '-a.b.c.msi'. Mogelijk is de build mislukt of zijn ze al hernoemd."
        }
        
        foreach ($file in $msiFiles) {
            $newName = $file.Name.Replace("-a.b.c", "-$version")
            $destination = Join-Path $file.DirectoryName $newName
            
            Write-Host "Hernoemen: $($file.Name) -> $newName"
            
            # Controleer of het doelbestand al bestaat om fouten te voorkomen
            if (Test-Path $destination) {
                Write-Host "Bestand $newName bestaat al, verwijderen van oud bestand..."
                Remove-Item $destination -Force
            }
            
            Move-Item -Path $file.FullName -Destination $destination -Force
        }
        Get-ChildItem -Path "bin\Setups\Release" -Filter "*.msi" -Recurse | Select-Object FullName
 
    - name: Copy .msi files to staging
      if: ${{ always() }}
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path staging
        Get-ChildItem -Path "bin\Setups\Release\" -Filter "*.msi" -Recurse | Copy-Item -Destination staging

    - name: Publish build artifacts
      if: ${{ always() }}
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.workflow }} package ${{ env.GITVERSION_FULLSEMVER }}
        path: staging/