name: .NET Desktop Build (VS2019)

on:
  push:
    branches:
      - '*'
  pull_request:
    branches:
      - '*'

env:
  SOLUTION: 'Dicom.sln'
  BUILD_PLATFORM: 'x86'
  BUILD_CONFIGURATION: 'Release'
  # Pad voor Visual Studio 2019 Enterprise op de GitHub Runner
  DEV_CMD: 'C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\Common7\IDE\devenv.com'
  DISABLE_TOOL_PATH: 'C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\Common7\IDE\CommonExtensions\Microsoft\VSI\DisableOutOfProcBuild'

jobs:
  build:
    runs-on: windows-2019 # Forceert het gebruik van de VS2019 omgeving

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v3.0.0
      with:
        versionSpec: '5.x'
        preferLatestVersion: true

    - name: Determine version number using GitVersion
      id: gitversion
      uses: gittools/actions/gitversion/execute@v3.0.0
      with:
        useConfigFile: true
        configFilePath: 'GitVersion.yml'
        updateAssemblyInfo: true

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
      with:
        nuget-config-file: 'NuGet.config'

    - name: Restore Nuget packages
      run: nuget restore ${{ env.SOLUTION }} -Verbosity Detailed

    - name: Update Version in project files
      shell: pwsh
      run: |
        ./DVT/updateVersion.ps1 -gitversion "${{ env.GITVERSION_FULLSEMVER }}"

    - name: Update Copyright year in AssemblyInfo files
      shell: pwsh
      run: |
        ./DVT/updateCopyright.ps1

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Locate Devenv and Fix HRESULT 8000000A
      shell: pwsh
      run: |
        # Search installation path of VS2019
        $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -version "[16.0,17.0)" -property installationPath
        if (-not $vsPath) { throw "Visual Studio 2019 niet gevonden!" }
        
        $devenv = Join-Path $vsPath "Common7\IDE\devenv.com"
        $disableTool = Join-Path $vsPath "Common7\IDE\CommonExtensions\Microsoft\VSI\DisableOutOfProcBuild\DisableOutOfProcBuild.exe"
        
        # Voer de fix uit voor de HRESULT 8000000A fout
        if (Test-Path $disableTool) {
          Write-Host "Execute DisableOutOfProcBuild.exe..."
          & $disableTool
        }
        
        Add-Content -Path $env:GITHUB_ENV -Value "DEV_CMD=$devenv"

    - name: Setup Visual Studio Installer Projects
      uses: seanmiddleditch/gha-setup-vsdevenv@v5

    - name: Build managed/native projects (msbuild)
      id: msbuild
      shell: cmd
      run: |
        msbuild Dicom.sln /t:Rebuild /p:Configuration=Release;Platform=x86 /m > build-msbuild.log 2>&1

    - name: Upload msbuild log
      if: ${{ always() }}
      uses: actions/upload-artifact@v4
      with:
        name: build-msbuild-log-${{ github.run_id }}
        path: build-msbuild.log

    - name: Build setup projects (devenv)
      id: vdproj
      continue-on-error: true
      shell: pwsh
      run: |
          $projects = @( "DVT Setup", "DICOM Editor Setup", "DICOM Compare Setup", "DICOM Network Analyzer Setup", "Query Retrieve SCP Emulator Setup", "Query Retrieve SCU Emulator Setup", "RIS Emulator Setup", "Storage SCP Emulator Setup", "Storage SCU Emulator Setup" )
          if (-not (Test-Path "$env:DEV_CMD")) { throw "DEV_CMD niet gevonden" }
          if (Test-Path build-devenv.log) { Remove-Item build-devenv.log -Force }
          foreach ($p in $projects) {
              Write-Host "=== Building setup project: $p ==="
              $buildParams = @( "$env:SOLUTION", '/Build', "$($env:BUILD_CONFIGURATION)|$($env:BUILD_PLATFORM)", '/Project', $p )
              
              Add-Content -Path build-devenv.log -Value ("`n=== CMD: $p ===") -Encoding UTF8
              
              # Bouw en toon output direct + sla op in log
              & "$env:DEV_CMD" @buildParams | ForEach-Object {
                  Write-Host $_ 
                  $_ | Out-File -FilePath build-devenv.log -Append -Encoding UTF8
              }
                $exit = $LASTEXITCODE
                if ($exit -ne 0) {
                Write-Host "ERROR: Project $p gefaald met exit code $exit"
                $env:BUILD_FAILED = "true" # Markeer voor later
                }
            }
            if ($env:BUILD_FAILED -eq "true") { exit 1 }

    - name: Show last lines of build log (only if build failed)
      if: ${{ steps.vdproj.outcome == 'failure' }} # Veranderd van 'build' naar 'vdproj'
      shell: pwsh
      run: |
        if (Test-Path build-devenv.log) {
          Get-Content build-devenv.log -Tail 200
        }

    - name: Upload build log
      if: ${{ always() }}
      uses: actions/upload-artifact@v4
      with:
        name: build-devenv-log-${{ github.run_id }}
        path: build-devenv.log

    - name: Rename msi's
      shell: cmd
      run: |
        rename ".\bin\Setups\Release\*-a.b.c.msi" "*-${{ env.GITVERSION_FULLSEMVER }}.msi"

    - name: Show versioned msi's
      shell: cmd
      run: dir .\bin\Setups\Release\

    - name: Run Tests
      if: ${{ always() }}
      shell: cmd
      run: |
        vstest.console.exe ".\bin\Release*Tests.dll"

    - name: Copy .msi files to staging
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path staging
        Copy-Item "bin\Setups\Release\*.msi" -Destination staging -Recurse

    - name: Publish build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.workflow }} package ${{ env.GITVERSION_FULLSEMVER }}
        path: staging/
